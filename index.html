<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Abastecimento</title>

<style>
* {
  box-sizing: border-box;
}

body {
  font-family: Arial, sans-serif;
  background: #f2f2f2;
}

.app {
  max-width: 420px;
  margin: auto;
  background: #ffffff;
  padding: 16px;
  border-radius: 12px;
}

h3 {
  text-align: center;
}

/* PADRONIZAÇÃO DOS CAMPOS */
select, input, textarea, button {
  width: 100%;
  height: 44px;
  margin-bottom: 12px;
  padding: 10px;
  font-size: 16px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

textarea {
  height: 80px;
  resize: none;
}

input[readonly] {
  background: #e9e9e9;
}

button {
  background: #2e7d32;
  color: white;
  border: none;
  font-weight: bold;
}

#preview {
  display: none;
  margin-bottom: 12px;
  max-width: 100%;
  border-radius: 6px;
}
</style>
</head>

<body>

<div class="app">
<h3>Registro de Abastecimento</h3>

<!-- DATA compatível com Google Forms -->
<input type="date" id="data" hidden>

<select id="motorista">
  <option value="">Selecione o motorista</option>
</select>

<select id="placa">
  <option value="">Selecione a placa</option>
</select>

<input type="text" id="veiculo" placeholder="Veículo" readonly>
<input type="text" id="combustivel" placeholder="Combustível" readonly>

<input type="number" id="km" placeholder="Km atual">
<input type="number" id="valor" placeholder="Valor pago">

<textarea id="obs" placeholder="Observação"></textarea>

<!-- FOTO DO COMPROVANTE -->
<input
  type="file"
  id="foto"
  accept="image/*"
  capture="environment"
>

<img id="preview">

<button onclick="salvar()">Salvar</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ============================
     CONFIGURAÇÃO CLOUDINARY
  ============================ */
  const CLOUD_NAME = "dtyl3vygq";
  const UPLOAD_PRESET = "comprovante_abastecimento";

  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQtoYEP8bgSfnJhmpP3l_Ao080h7U2_z9r5_AZFylu2KtlYqgkUhWlpXvvkc7owNA2Q8kIvAA34lR6K/pub?gid=673866119&single=true&output=csv";

  const placa = document.getElementById("placa");
  const motorista = document.getElementById("motorista");
  const veiculo = document.getElementById("veiculo");
  const combustivel = document.getElementById("combustivel");
  const km = document.getElementById("km");
  const valor = document.getElementById("valor");
  const obs = document.getElementById("obs");
  const data = document.getElementById("data");
  const foto = document.getElementById("foto");
  const preview = document.getElementById("preview");

  let dados = [];

  function dataHojeISO() {
    const d = new Date();
    const ano = d.getFullYear();
    const mes = String(d.getMonth() + 1).padStart(2, "0");
    const dia = String(d.getDate()).padStart(2, "0");
    return `${ano}-${mes}-${dia}`;
  }

  data.value = dataHojeISO();

  /* ============================
     CARREGA CSV (SEM ALTERAÇÃO)
  ============================ */
  fetch(CSV_URL)
    .then(r => r.text())
    .then(csv => {

      const linhas = csv.trim().split("\n").slice(1);

      dados = linhas.map(l => {
        const cols = l.split(",").map(c =>
          c.replace(/"/g, "").trim()
        );

        const [placa, veiculo, combustivel, motorista] = cols;
        return { placa, veiculo, combustivel, motorista };
      });

      [...new Set(dados.map(d => d.placa))].forEach(p => {
        placa.innerHTML += `<option value="${p}">${p}</option>`;
      });

      [...new Set(dados.map(d => d.motorista))].forEach(m => {
        motorista.innerHTML += `<option value="${m}">${m}</option>`;
      });
    });

  placa.addEventListener("change", () => {
    const item = dados.find(d => d.placa === placa.value);
    if (!item) return;

    veiculo.value = item.veiculo;
    combustivel.value = item.combustivel;
    motorista.value = item.motorista;
  });

  /* ============================
     PREVIEW DA FOTO
  ============================ */
  foto.addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    preview.src = URL.createObjectURL(file);
    preview.style.display = "block";
  });

  /* ============================
     UPLOAD DA FOTO
  ============================ */
  async function uploadFoto() {
    if (!foto.files.length) return "";

    const formData = new FormData();
    formData.append("file", foto.files[0]);
    formData.append("upload_preset", UPLOAD_PRESET);

    const res = await fetch(
      `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,
      { method: "POST", body: formData }
    );

    const data = await res.json();
    return data.secure_url || "";
  }

  /* ============================
     SALVAR (GOOGLE FORMS)
  ============================ */
  window.salvar = async function () {

    if (!placa.value || !motorista.value) {
      alert("Selecione motorista e placa");
      return;
    }

    const comprovanteUrl = await uploadFoto();

    const url = "https://docs.google.com/forms/d/e/1FAIpQLScXKfKxd-XUUtiRvpSRfYCko-evf5-RXD4tcnYJEi-G5sN2DQ/formResponse";

    const f = new FormData();
    f.append("entry.162808806", data.value);
    f.append("entry.113910042", motorista.value);
    f.append("entry.1999077403", placa.value);
    f.append("entry.2134801924", veiculo.value);
    f.append("entry.632861079", combustivel.value);
    f.append("entry.134373363", km.value);
    f.append("entry.20307542", valor.value);
    f.append("entry.1919028848", comprovanteUrl);
    f.append("entry.1800305306", obs.value);    

    fetch(url, { method: "POST", mode: "no-cors", body: f });

    alert("Abastecimento registrado!");
    location.reload();
  };

});
</script>

</body>
</html>
